<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

<link href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">
<script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
<script src="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>

<link href="https://cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.0/bootstrap3-editable/css/bootstrap-editable.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.0/bootstrap3-editable/js/bootstrap-editable.min.js"></script>

<link href=""/>

<%page expression_filter="h"/>
##<%inherit file="main.html" />
<%namespace name='static' file='../../static_content.html'/>

<%!
from django.core.urlresolvers import reverse
from courseware.url_helpers import get_redirect_url
from pprint import pprint
%>

<%block name="header_extras">
% for template_name in ["donation"]:
<script type="text/template" id="${template_name}-tpl">
  <%static:include path="dashboard/${template_name}.underscore" />
</script>
% endfor
</%block>

    <section class="container" >

      <br><br>

         <ol class="breadcrumb">
          <li><a href="${marketing_link('ROOT')}">ALUx Platform</a></li>
          <li><a href="${reverse('skills_map:skills-hq')}">HQ</a></li>
          <li><a href="${reverse('skills_map:gradebook')}">Gradebook</a></li>
          <li><a href="${reverse('skills_map:assignment-list', kwargs={'course_id': assignment.course_id})}">
                ${course.display_name}
             </a></li>
          <li class="active">${assignment.name}</li>
        </ol>

##         <form method="POST" enctype="multipart/form-data" action="/skills/gradebook">

        <p></p><a href="${reverse('skills_map:assignment-list', kwargs={'course_id': assignment.course_id})}">
                <i class="fa fa-arrow-left" aria-hidden="true"></i> Back to ${course.display_name}
        </a>


        <div class="row" style="padding-bottom:0px;margin-bottom: 0px;">
            <div class="col-md-8">
                <h1>
                    <a href="${url}" target="_blank" style="color: inherit">${assignment.name}
                        <i class="fa fa-external-link" aria-hidden="true" style="color: #428bca"></i>
                    </a>
                </h1>

            </div>

            <br>


            <div class="col-md-4">
                <div class="pull-right">
                    % if assignment.assignment_type == "formative":
                        <div class="btn-group" data-toggle="buttons" id="edit-ass-type">
                            <label class="btn btn-primary formative-summative"
                                   data-loading-text="<i class='fa fa-spinner fa-pulse'></i> Formative">
                                <input type="radio" name="options" id="formative"> Formative
                            </label>
                            <label class="btn btn-default formative-summative"
                                   data-loading-text="<i class='fa fa-spinner fa-pulse'></i> Summative">
                                <input type="radio" name="options" id="summative"> Summative
                            </label>
                        </div>
                    % elif assignment.assignment_type == "summative":
                        <div class="btn-group" data-toggle="buttons" id="edit-ass-type">
                            <label class="btn btn-default formative-summative"
                                   data-loading-text="<i class='fa fa-spinner fa-pulse'></i> Formative">
                                <input type="radio" name="options" id="formative"> Formative
                            </label>
                            <label class="btn btn-primary formative-summative"
                                   data-loading-text="<i class='fa fa-spinner fa-pulse'></i> Summative">
                                <input type="radio" name="options" id="summative"> Summative
                            </label>
                        </div>
                    % endif
                </div>
            </div>

        </div>

        <hr style="padding:0px;margin-top:0px;height:3px;border:none;color:#eee;background-color:#eee;">

##         <p><a href="${url}">Go to assignment</a></p>

        <div class="row">

            <div class="col-md-12">
                <div class="row">
                    <div class="col-md-12">
                        <h3>Linked Learning Outcomes</h3>
                    </div>
                </div>


                <br>

                <div class="row col-md-12">
                    <a type="button" class="btn btn-default" id="create-item-modal">
                        <i class="fa fa-link"></i> Link a Learning Outcome
                    </a>

                    <a type="button" class="btn btn-danger" id="unlink-lo-modal">
                        <i class="fa fa-chain-broken"></i> Unlink
                    </a>
                </div>
                <br>



                <div class="row col-md-12">

                    <table class="table col-md-12 table-striped table-bordered">
                        <thead>
                            <th>LO</th>
                            <th>Desc</th>
                            <th>L 1</th>
                            <th>L 2</th>
                            <th>L 3</th>
                            <th>L 4</th>
                            <th>L 5</th>
                        </thead>

                        <tbody>

                            % for i, LO in enumerate(assignment.learning_outcomes.all()):
                                <tr>
                                    <td>${LO}</td>
                                    <td>This is the description of an LO. Who really knows anything</td>
                                    <td>A Level 1 means this</td>
                                    <td>A Level 2 means this</td>
                                    <td>A Level 3 means this</td>
                                    <td>A Level 4 means this</td>
                                    <td>A Level 5 means this</td>
                                </tr>
                            % endfor

                        </tbody>

                    </table>

                </div>

            </div>

            <br><br>

        </div>


        <h3>Student Gradebook</h3>
        <div class="collapse-group">
            % for cohort in gradebooks:
                <%
                    gradebook = cohort.get('gradebook')
                %>

                <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="heading-${cohort.get('id')}">
                      <h4 class="panel-title">
                        <a role="button" data-toggle="collapse" href="#collapse${cohort.get('code_name')}" aria-expanded="true" aria-controls="collapse${cohort.get('code_name')}" class="trigger collapsed">
                          ${cohort.get('name')}
                        </a>
                      </h4>
                    </div>

                    <div id="collapse${cohort.get('code_name')}" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading-${cohort.get('id')}">
                        <div class="panel-body">

                          <div class="row">
                              <div class="col-md-6">
                                  <button type="button" class="btn btn-default" id="data-download">
                                      <i class="fa fa-download" aria-hidden="true"></i>
                                      Download Grading Sheet
                                  </button>
                              </div>

                              <div class="col-md-6">
                                  <form method="POST" enctype="multipart/form-data" action="${reverse('skills_map:grade-sheet-upload',
                                  kwargs={'course_id':assignment.course_id, 'usage_id': str(assignment.assignment_id)})}">
                                      <input type="hidden" name="csrfmiddlewaretoken" value="${ csrf_token }">
                                      <tr><th><label for="id_file">Upload Grading Sheet:</label></th><td><input id="id_file" name="my_file" type="file" /></td></tr>
                                      <br>
                                      <button class="btn btn-default" type="submit" value="Upload">
                                          <i class="fa fa-upload" aria-hidden="true"></i>
                                          Upload Grading Sheet
                                      </button>
                                  </form>
                              </div>
                          </div>

                          <br>

                          <div class="row">
                              <table id="table-${cohort.get('id')}" class="table table-striped table-bordered" cellspacing="0" width="100%">
                                  <tr>
                                      <th>
                                          Student Email
                                      </th>
                                      % for lo in assignment.learning_outcomes.all():
                                          <th>
                                              ${lo}
                                          </th>

                                          <th>
                                              ${lo} Comments
                                          </th>
                                      % endfor
                                      <th>
                                          General Comments
                                      </th>
                                  </tr>

                                  % for row in gradebook:
                                      <tr>
                                          % for i, entry in enumerate(row):
                                              %if entry.get('email_display'):
                                                  <td>${entry.get('email_display')}</td>
                                              %endif


                                              %if entry.get('type', '') == "lo":
                                                  %if entry.get('lo_display', '') == "":
                                                      <td> <a href="#" id="scored-lo-${entry.get('id', 'none')}">Empty</a> </td>
                                                  % else:
                                                      <td> <a href="#" id="scored-lo-${entry.get('id', 'none')}">  </a> </td>
                                                  %endif

                                                  %if entry.get('lo_comments', '') == "":
                                                      <td> <a href="#" id="scored-lo-comments-${entry.get('id', 'none')}">Empty</a> </td>
                                                  % else:
                                                      <td> <a href="#" id="scored-lo-comments-${entry.get('id', 'none')}"
                                                              data-value="${entry.get('lo_comments', '')}">  </a> </td>
                                                  %endif
                                              %endif


                                              %if entry.get('type', '') == "comments":
                                                  %if entry.get('comments_display', '') == "":
                                                      <td> <a href="#" id="comments-${entry.get('id', 'none')}">Empty</a> <td>
                                                  % else:
                                                     <td> <a href="#" id="comments-${entry.get('id', 'none')}"
                                                             data-value="${entry.get('comments_display', '')}">  </a> </td>
                                                  %endif
                                              %endif

                                              %if entry.get('type', '') == "status":
                                                  <div id="publish-unpublish">

                                                    %if entry.get('published', '') == True:
                                                        <td>
                                                            <a id="publish-grade-${entry.get('scored_assignment_id', 'none')}"
                                                              class="publish-grade-${entry.get('scored_assignment_id', 'none')}"
                                                              data-scored-assignemnt-id="${entry.get('scored_assignment_id', 'none')}"
                                                               data-action="unpublish">

                                                            <span id="publish-icon-${entry.get('scored_assignment_id', 'none')}"
                                                                  style="color: forestgreen; cursor:pointer">
                                                                <i class="fa fa-check-circle"></i>
                                                            </span>

                                                            </a>
                                                        <td>
                                                    % else:
                                                       <td>
                                                        <a id="publish-grade-${entry.get('scored_assignment_id', 'none')}"
                                                               class="publish-grade-${entry.get('scored_assignment_id', 'none')}"
                                                               data-scored-assignemnt-id="${entry.get('scored_assignment_id', 'none')}"
                                                                data-action="publish">

                                                            <span id="publish-icon-${entry.get('scored_assignment_id', 'none')}"
                                                                    style="color: dimgrey; cursor:pointer">
                                                                <i class="fa fa-cloud-upload"></i>
                                                            </span>
                                                        </a>
                                                       <td>
                                                    %endif

                                                  </div>
                                              %endif


                                          % endfor
                                      </tr>
                                  % endfor
                              </table>
                          </div>

                      </div>

                    </div>
                </div>


            % endfor
        </div>

    </section>


    <br><br><br>

    <div id="create-modal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">

    <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Add a Learning Outcome</h4>
            </div>
              <div class="modal-body">
                 <form action="${reverse('skills_map:link-learning-outcome')}" method="post">
                     <input type="hidden" name="csrfmiddlewaretoken" value="${ csrf_token }">
                     <input type="hidden" name="assignment-id" value="${assignment.assignment_id}">

                      <div class="input-group">
                          <div class="form-group">
                              <label for="sel1">Select a learning outcome to add:</label>
                              <select class="form-control" name="learning-outcome-slug">
                                  % for LO in [lo for lo in learning_outcomes if lo not in list(assignment.learning_outcomes.all())]:
                                      <option value='${LO.slug}'>
                                        ${LO.name}
                                      </option>
                                  % endfor

                              </select>
                          </div>
                      </div>

                    <br>
                    <br>
                    <input class="btn btn-default pull-right" type="submit" value="Link">
                    <br>
                    <br>

                 </form>
              </div>
            </div>
        </div>
    </div>

    <div id="unlink-modal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">

    <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Unlink a Learning Outcome</h4>
            </div>
              <div class="modal-body">
                 <form action="${reverse('skills_map:unlink-learning-outcome')}" method="post">
                     <input type="hidden" name="csrfmiddlewaretoken" value="${ csrf_token }">
                     <input type="hidden" name="assignment-id" value="${assignment.assignment_id}">

                      <div class="input-group">
                          <div class="form-group">
                              <label for="sel1">Select a learning outcome to unlink:</label>
                              <select class="form-control" name="learning-outcome-slug">
                                  % for LO in assignment.learning_outcomes.all():
                                      <option value='${LO.slug}'>
                                        ${LO.name}
                                      </option>
                                  % endfor

                              </select>
                          </div>
                      </div>

                    <br>
                    <br>
                    <input class="btn btn-danger pull-right" type="submit" value="Unlink">
                    <br>
                    <br>

                 </form>
              </div>
            </div>
        </div>
    </div>


<script>
    const button = `<button type="button" class="btn btn-default" id="data-download">
                        <i class="fa fa-refresh fa-spin"></i>
                        Preparing Most Recent Data
                       </button>`
    const old_button = `<button type="button" class="btn btn-default" id="data-download">
                        Download Most Recent Data
                       </button>`
    $('#data-download').click(function() {
        $('#data-download').replaceWith(button);
        window.open('${reverse("skills_map:grade-sheet-download",
                                kwargs={"course_id": assignment.course_id, "usage_id": assignment.assignment_id})}',
                                "_self");
        setTimeout(function() {
            $('#data-download').replaceWith(old_button);
        }, 10 * 1000);

    });

     $('#create-item-modal').click(function() {
                $('#create-modal').modal('show');
            });
     $('#unlink-lo-modal').click(function() {
                $('#unlink-modal').modal('show');
            });

</script>

<script>
    $(document).ready(function() {
        //toggle `popup` / `inline` mode
        $.fn.editable.defaults.mode = 'popup';

         % for item in gradebooks:
             <%
                gradebook = item.get('gradebook')
             %>

                 % for row in gradebook:
                     % for entry in row:
                         % if entry.get('id') and entry.get('type') == 'lo':

                            $('#scored-lo-${entry.get('id')}').editable({
                                type: 'number',
                                title: 'Edit LO Score',
                                placement: 'right',
                                value: ${entry.get('lo_display') if entry.get('lo_display') else '0'},
                                url: '${reverse('skills_map:add-scored-lo')}',
                                pk: ${i+1},
                                params: function(params) {  //params already contain `name`, `value` and `pk`
                                    var data = {};
                                    data['id'] = params.name;
                                    data['value'] = params.value;
                                    data['csrfmiddlewaretoken'] = '${ csrf_token }';
                                    return data;
                                },
                                success: function(response) {
                                    location.reload();
                                },
                            });


                            $('#scored-lo-comments-${entry.get('id')}').editable({
                                type: 'textarea',
                                title: 'Edit LO Comments',
                                placement: 'right',
                                rows: 4,
                                escape: false,
                                url: '${reverse('skills_map:add-lo-comments')}',
                                value: "",
                                pk: ${i+1},
                                params: function(params) {  //params already contain `name`, `value` and `pk`
                                    var data = {};
                                    data['id'] = params.name;
                                    data['value'] = params.value;
                                    console.log(data['id']);
                                    console.log(params.value);
                                    data['csrfmiddlewaretoken'] = '${ csrf_token }';
                                    return data;
                                },
                                success: function(response) {
                                    location.reload();
                                },
                            });

                         % endif


                        % if entry.get('id') and entry.get('type') == 'comments':
                            $('#comments-${entry.get('id')}').editable({
                                type: 'textarea',
                                title: 'Edit General Comments',
                                placement: 'right',
                                rows: 4,
                                escape: false,
                                url: '${reverse('skills_map:add-comments')}',
                                value: "",
                                pk: ${i+1},
                                params: function(params) {  //params already contain `name`, `value` and `pk`
                                    var data = {};
                                    data['id'] = params.name;
                                    data['value'] = params.value;
                                    console.log(data['id']);
                                    console.log(params.value);
                                    data['csrfmiddlewaretoken'] = '${ csrf_token }';
                                    return data;
                                },
                                success: function(response) {
                                    location.reload();
                                },
                            });
                        % endif

                     % endfor
                 % endfor
         % endfor
    });

</script>

<script type="text/javascript">
    $(document).on('click', '.formative-summative', function(){
        var $this = $(this);
        var buttonId = ($(this).find('input').attr('id'));
        console.log(buttonId)
        var assignmentId = '${assignment.assignment_id}';

        const summativeSelected = `<div class="btn-group" data-toggle="buttons" id="edit-ass-type">
                                        <label class="btn btn-default formative-summative"
                                          data-loading-text="<i class='fa fa-spinner fa-pulse'></i> Formative">
                                            <input type="radio" name="options" id="formative"> Formative
                                        </label>
                                        <label class="btn btn-primary formative-summative"
                                          data-loading-text="<i class='fa fa-spinner fa-pulse'></i> Summative">
                                            <input type="radio" name="options" id="summative"> Summative
                                        </label>
                                    </div>`

        const formativeSelected = `<div class="btn-group" data-toggle="buttons" id="edit-ass-type">
                                        <label class="btn btn-primary formative-summative"
                                          data-loading-text="<i class='fa fa-spinner fa-pulse'></i> Formative">
                                            <input type="radio" name="options" id="formative"> Formative
                                        </label>
                                        <label class="btn btn-default formative-summative"
                                          data-loading-text="<i class='fa fa-spinner fa-pulse'></i> Summative">
                                            <input type="radio" name="options" id="summative"> Summative
                                        </label>
                                    </div>`

        $this.button('loading');
        $.post("${reverse('skills_map:edit-assignment-type')}",
        {
            'requestedAssignmentType': buttonId,
            'assignmentId': assignmentId,
            'csrfmiddlewaretoken': '${ csrf_token }'
        },
        function(data, status){
            if(data.newAssignmentType == 'formative'){
                $('#edit-ass-type').replaceWith(formativeSelected);
            }else if(data.newAssignmentType == 'summative'){
                $('#edit-ass-type').replaceWith(summativeSelected);
            }
            $this.button('reset');
        });
    });
</script>


<script type="text/javascript">

    % for item in gradebooks:
         <%
             gradebook = item.get('gradebook')
         %>

          % for row in gradebook:
              % for entry in row:

                  % if entry.get('type') == 'status':
                      $(document).on('click', '.publish-grade-${entry.get('scored_assignment_id')}', function(){

                        var $this = $(this);
                        var buttonId = ($(this).attr('id'));
                        var scoredAssignmentId = ($(this).attr('data-scored-assignemnt-id'));
                        var action = ($(this).attr('data-action'));

                        const unpublished = `<a id="publish-grade-${entry.get('scored_assignment_id')}"
                                                               class="publish-grade-${entry.get('scored_assignment_id')}"
                                                               data-scored-assignemnt-id="${entry.get('scored_assignment_id')}"
                                                                data-action="publish">

                                                            <span style="color: dimgrey; cursor:pointer">
                                                                <i class="fa fa-cloud-upload"></i>
                                                            </span>
                                                        </a>`

                        const published = `<a id="publish-grade-${entry.get('scored_assignment_id')}"
                                                              class="publish-grade-${entry.get('scored_assignment_id')}"
                                                              data-scored-assignemnt-id="${entry.get('scored_assignment_id')}"
                                                               data-action="unpublish">

                                                            <span style="color: forestgreen; cursor:pointer">
                                                                <i class="fa fa-check-circle"></i>
                                                            </span>

                                                            </a>`


                          const spinner = `<span id="publish-icon-${entry.get('scored_assignment_id', 'none')}"
                                                                    style="color: dimgrey; cursor:pointer">
                                                                <i class="fa fa-spinner fa-pulse"></i>
                                                            </span>`

                          $('#publish-icon-${entry.get('scored_assignment_id')}').replaceWith(spinner);

                        $.post("${reverse('skills_map:publish-scored-assignment')}",
                        {
                            'scoredAssignmentId': scoredAssignmentId,
                            'action': action,
                            'csrfmiddlewaretoken': '${ csrf_token }'
                        },
                        function(data, status){
                            if(data.published == "True"){
                                $('#publish-grade-${entry.get('scored_assignment_id')}').replaceWith(published);
                            }else if(data.published == "False"){
                                $('#publish-grade-${entry.get('scored_assignment_id')}').replaceWith(unpublished);
                            }

                        });
                      });

                  %endif
              %endfor
          %endfor

    % endfor


</script>
